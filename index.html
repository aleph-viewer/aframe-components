<html>
  <head>
    <script src="https://aframe.io/releases/1.0.3/aframe.min.js"></script>
    <script src="ami.min.js"></script>
    <script src="VolumetricLoader.js"></script>
    <script src="THREE.MeshLine.js"></script>
    <script src="components/al-bounding-box.js"></script>
    <script src="components/al-gltf-model.js"></script>
    <script src="components/al-orbit-control.js"></script>
    <script src="components/al-control-lights.js"></script>
    <script src="components/al-volume.js"></script>
    <script src="utils.js"></script>
    <script src="OrbitControls.js"></script>
    <script src="constants.js"></script>
    <style>
      body {
        background: #000;
      }
    </style>
  </head>
  <body>
    <div id="lut-container">
      <div id="lut-min">0.0</div>
      <div id="lut-canvases" />
      <div id="lut-max">1.0</div>
    </div>
    <a-scene
      renderer="colorManagement: true; sortObjects: true; antialias: true"
      vr-mode-ui="enabled: false"
      light="defaultLightsEnabled: false">
      <a-entity id="model-container">
        <a-entity id="src" al-volume="src: https://alembic-dcm.netlify.com/shrew400/shrew400.dcm"></a-entity>
        <!-- <a-entity id="src" al-gltf-model="src: https://aleph-gltf-models.netlify.com/Frog.glb"></a-entity> -->
        <!-- <a-entity id="src" al-gltf-model="src: https://aleph-gltf-models.netlify.com/FlightHelmet.glb"></a-entity> -->
        <!-- <a-entity id="src" al-gltf-model="src: https://aleph-gltf-models.netlify.com/BoxTextured.glb"></a-entity> -->
        <a-entity id="bounding-box"></a-entity>
      </a-entity>
      <a-camera
        id="main-camera"
        fov="45"
        near="0.05"
        look-controls="enabled: false"
        far="10000"
      />
    </a-scene>
    <script>
      const scene = document.querySelector("a-scene");
      const boundingBox = document.getElementById("bounding-box");
      const camera = document.getElementById("main-camera");

      function center(mesh) {
        mesh.geometry.center(); 
      }

      function center(model) {
        const box = getBoundingBox(model);
        const center = box.getCenter(new THREE.Vector3());
        model.position.x += (model.position.x - center.x);
        model.position.y += (model.position.y - center.y);
        model.position.z += (model.position.z - center.z);
      }

      function setupBoundingBox(model) {
        const box = getBoundingBox(model);
        const size = new THREE.Vector3();
        box.getSize(size);
        boundingBox.setAttribute("al-bounding-box", "scale:" + stringifyVec3(size));
      }

      function setupCamera(model) {
        const cameraState = getCameraStateFromModel(model, Constants.zoomFactor, Constants.fov);
        camera.setAttribute("al-orbit-control",
          "controlPosition:" + stringifyVec3(cameraState.position) + ";" +
          "controlTarget:" + stringifyVec3(cameraState.target) + ";" +
          "minPolarAngle: 0.25;" +
          "maxPolarAngle: 175;" +
          "minDistance: 0;" +
          "screenSpacePanning: true;" +
          "rotateSpeed: 0.5;" +
          "zoomSpeed: 1;" +
          "enableDamping: true;" +
          "dampingFactor: 0.25;" +
          "panSpeed: 0.25");
        camera.setAttribute("al-control-lights", "");
      }

      window.addEventListener("DOMContentLoaded", (event) => {
        scene.addEventListener("al-model-loaded", modelLoaded, false);
        scene.addEventListener("al-volume-loaded", volumeLoaded, false);
      });

      function modelLoaded(e) {
        const model = e.detail.model;
        center(model);
        setupBoundingBox(model);
        setupCamera(model);
      }

      function volumeLoaded(e) {
        console.log("volume loaded");
        const model = getMesh(e.detail);
        center(model);
        setupBoundingBox(model);
        setupCamera(model);
      }
    </script>
  </body>
</html>